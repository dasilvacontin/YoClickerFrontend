<!DOCTYPE html>
<html lang="en">
<title>YoClicker - <%= pollName %></title>
<%- include head.ejs %>
<meta name="viewport" content="minimal-ui">
<style type="text/css">

  .wrapper {
    box-sizing: border-box;
    width: 100%;
    height: 100%;
    padding: 20px;
  }

  .chart {
    width: 100%;
    height: 100%;
    font-size: 20px;
  }

  .kek {
    font-family: 'Montserrat';
    font-size: 30px;
    line-height: 40px;
    text-align: right;
    margin: 15px;
    padding: 0px;
    position: absolute;
    bottom: 0px;
    right: 0px;
    color: white;
    z-index: 10;
  }

</style>
<head>
</head>
<body>
<script src="/js/runOnLoad.js"></script>
<script src="/js/HighchartsAdapter.js" type="text/javascript"></script>
<script src="/js/highcharts.src.js" type="text/javascript"></script>
<script src='/js/yoChartTheme.js'></script>
<p class="kek">YO THIS!<br>SHARE THE RESULTS</p>
<script>

  /*
  var series = [{
    type: 'pie',
    data: [
        ['Yehuda Katz', 450],
        ['Angus Croll', 260],
        ['Substack', 120],
        ['Justin Meyer', 80],
        ['Paul O’Shannessy', 450],
        ['John-David Dalton', 260],
        ['Domenic Denicola', 120],
        ['Julien Lecomte', 80],
        ['Soledad Penadés', 80],
        ['Joe McCann', 80],
        ['Charlie Robbins', 80],
        ['Mike McNeil', 80]
    ]
  }];
  */

  var questions = JSON.parse(unescape("<%- json %>")).result;
  var charts = [];
  var pollURL = "<%= pollURL %>";

  function newChart(i, question) {

    var uid = 'chart'+i;

    var w = document.createElement('div');
    w.className = 'wrapper';
    w.setAttribute('id', uid);
    document.body.appendChild(w);

    charts.push(new Highcharts.Chart({
    chart : {
      renderTo : uid,
      type     : 'pie'
    },
    credits: {
      enabled: false
    },
    title: {
        text: question.question
    },
    series: [{
      type: 'pie',
      data: question.answers
    }]
    }));

  }

  function updateCharts(questions) {
    console.log("updated charts");
    for (var i = 0; i < questions.length; ++i) {
      charts[i].series[0].setData(questions[i].answers);
    }

  }

  // create a new chart
  runOnLoad(function(){

    for (var i = 0; i < questions.length; ++i)
      newChart(i, questions[i]);

    setInterval(function () {

      var pollRequest = new XMLHttpRequest();
      pollRequest.open(
        'GET',
        pollURL,
        true
      );
      //pollRequest.withCredentials = true;
      pollRequest.send();
      pollRequest.onerror = function () {
        console.log("request error");
      }
      pollRequest.onload = function () {
        var json;
        try { json = JSON.parse(pollRequest.responseText); }
        catch (e) { return console.log("backend error"); }
        updateCharts(json.result);
      }

    }, 5000);

  });

</script>
</body>
</html>